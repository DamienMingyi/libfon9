<!-- 顯示從 WsSeedVisitor 取得的資料, 處理 UI 的異動(增刪改)事件通知. -->
<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <title>fon9seed</title>
   <link rel="stylesheet" href="./fon9.css">
   <link rel="stylesheet" href="./gv.css">
   <script src="./utils-seed.js"></script>
   <style>
      * {
        font-family: Consolas;
      }

      #topContainer {
        position: relative;
        height: 1.5em;
        display: flex;
        clear: both;
        background: #eee;
      }
      #topLeft {
        position: relative;
        height: calc(1.5em - 1px);
        flex-grow: 1;
      }
      #edPath {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        border: none;
        color: #eee;
        background: #eee;
      }
      #edPath:focus {
        z-index: 20;
        color: black;
        background: white;
      }
      #tabsArea {
        position: relative;
        float: left;
        z-index: 10;
      }
      .tab {
        float: left;
      }
      .tab label {
        position: relative;
        left: 1px;
        padding: 5px;
        margin-left: -1px;
        border: 1px solid #ccc;
        border-radius: 15px 15px 0 0;
        background: #ddd;
      }
      .tab label:hover{
        background: #eff;
      }
      .tab [type=radio] {
        display: none;
      }
      .tab [type=radio]:checked ~ label {
        background: white;
        border-bottom: 1px solid white;
        z-index: 2;
      }
      .seed {
        float: left;
        height: 1.5em;
        padding: 0 5px;
        outline: none;
        border: none;
        border-radius: 2px;
        background: #ddd;
      }
      .seed:hover {
        background: #eff;
        cursor: default;
      }
      .seed:disabled {
        background: #ddd;
      }
   </style>
</head>

<body>
   <div>
      <div id="topContainer">
         <div id="topLeft">
            <div id="tabsArea"></div>
            <input type="text" id="edPath" autocomplete="off" onfocus="this.value=currPath; this.select();" onkeydown="return edPathKeyDown(event)" />
         </div>
         <div id="topRight">
            <button id="btnReload" type="button" class="seed" onclick="reload();">
               &#8635;</button>
            <button id="btnAddNewRow" type="button" class="seed" onclick="addNewRow();" title="Add a row">
               &#65291;</button>
            <button id="btnDeleteRow" type="button" class="seed" onclick="deleteRow();">
               &#65293;</button>
         </div>
      </div>
      <textarea id="clipboard" style="display: none"></textarea>
   </div>

   <!-- public --> <script>
      /// 當 KeyCell click 時觸發 onLoadLayout(currPath, key, tabName);
      var onLoadLayout;
      /// 當 Tab click 或需要 reload 時觸發 onLoadGridView(currPath, startkey, tabName);
      /// startkey 有可能是 undefined, 表示從第一筆開始;
      var onLoadGridView;
      /// 當選定新的路徑時觸發 onPathChanged(newPath);
      var onPathChanged;
      /// 當欄位異動 或 add a row 時觸發 onFieldChanged(currPath, key, tabName, fieldValues);
      var onFieldChanged;
      /// 當想要刪除 row 時觸發 onDeleteRow(currPath, key);
      var onDeleteRow;
      /// 執行 seed 命令, onSeedCommand(seedName, command);
      var onSeedCommand;

      function clearAll() {
         currPath = '';
         currTabIdx = 0;
         tabsArea.innerHTML = '';
         document.getElementById('btnDeleteRow').removeAttribute('title');
         document.getElementById('btnReload').removeAttribute('title');
         gview.clearAll();
      }
      function renderLayout(path, strLayout, errmsg) {
         if (currPath == path || errmsg)
            return;
         gview.clearAll();
         currPath = path;
         // 解析送來的 layout 訊息.
         let strs = strLayout.split('\n'); // [0]=accessRights, [1]=layout;
         accessRights = parseInt(strs[0].substring(1), 16);// strs[0]=xHH
         layout = JSON.parse(strs[1]);
         for (let tab of layout.tabs) {
            tab.flags = parseHexFlags(tab.flags);
            if (!tab.fields)
               tab.fields = [];
            for (let fld of tab.fields)
              fld.flags = parseHexFlags(fld.flags);
         }
         layout.flags = parseHexFlags(layout.flags);
         // 根據 flags 設定 UI 元件.
         document.getElementById('btnAddNewRow').disabled = !(layout.flags & 0x01) || !hasWriteAccess();
         document.getElementById('btnDeleteRow').disabled = !(layout.flags & 0x02) || !hasWriteAccess();
         // 建立 path/tab 區的 UI 元件.
         currTabIdx = -1;
         addPathSeedElements(path);
         if (layout.tabs.length > 1) {
            let btn = document.createElement('button');
            btn.textContent = '^';
            btn.className = 'seed';
            btn.disabled = true;
            tabsArea.appendChild(btn);
            for (let tab of layout.tabs)
              addTabElements(++currTabIdx, tab);
         }
         // 使用首個 tab, 並載入 gridview.
         setCurrTabIdx(0);
      }
      function renderGridView(args, path, res, errmsg) {
         if (path != currPath || errmsg)
            return;
         if (parseTabIdx(args) != currTabIdx)
            return;
         gview.clearBody();
         let lines = res.split('\n');
         // first line(lines[0]) = rowCount,distanceBegin,distanceEnd
         if (lines.length > 1) {
            // 所以從 lines[1] 開始才是每行的內容:
            for (let i = 1; i < lines.length; ++i) {
               let flds = lines[i].split('\x01');
               let rowe = gview.addBodyRow(flds[0]);
               for (let i = 1; i < flds.length; ++i)
                  gview.addBodyCell(rowe, flds[i]);
            }
         }
         // 載入表格資料之後, 把第一格設為 focus.
         gview.setFirstCellFocus();
      }
      function updateRow(args, path, res, errmsg) {
         if (errmsg)
            return;
         let row = searchRowByFullPathName(path);
         if (!row)
            return;
         let cells = row.cells;
         cells[0].classList.remove('gvUpdatingCell'); // 移除 addNewRow() 時設定的 class.
         let lines = res.split('\n');
         let flds = lines[0].split('\x01');
         let i = 1;
         for (let fld of flds) {
            if (i >= cells.length)
               gview.addBodyCell(row, fld);
            else {
               // 應該要檢查 args = 'fieldName=newValue' 其中的 fieldName.
               // 如果是當初要求的異動, 才移除 gvUpdatingCell;
               let cell = cells[i];
               cell.classList.remove('gvUpdatingCell');
               cell.textContent = fld;
            }
            ++i;
         }
      }
      function seedRemoved(seedName, info, errmsg) {
         if (errmsg)
            return;
         gview.removeRow(searchRowByFullPathName(seedName));
      }
      function seedCommandResult(res, errmsg) {
         if (res[0] == '?') {
            buildSeedMenuItems(res, errmsg);
            return;
         }
         if (!errmsg)
            errmsg = '';
         // res = cmd + '\x01' + seedName + '\n' + result;
         let pln = res.indexOf('\n');
         if (pln >= 0) {
            errmsg += res.substring(pln);
            res = res.substring(0, pln);
            if (errmsg.trim() === '')
               errmsg = "\nSeedCommand done.";
         }
         res = res.replace('\x01', '\n');
         alert(res + '\n' + errmsg);
      }
   </script>
   <!-- private --> <script>
      // 觸發 onLoadGridView() 事件.
      let emitLoadGridView = function (startkey) {
         if (onLoadGridView)
            onLoadGridView(currPath, startkey, getCurrTabName());
      }
      // 觸發 onPathChanged() 事件.
      let emitPathChange = function (newPath) {
         if (onPathChanged && newPath != currPath)
            onPathChanged(newPath);
      }

      let tabsArea = document.getElementById('tabsArea');
      let clipboard = document.getElementById('clipboard');
      let gview;
      let layout;
      let currTabIdx;
      let currPath;
      let prevPath;     // for [Backspace]
      let accessRights; // 在 renderLayout() 取得 path layout 時, 會設定 currPath 的可用權限.

      // 若 currTabIdx 為 0(這是最常發生的情況) 則傳回 ''; 否則傳回 tabName.
      let getCurrTabName = function () {
         return (currTabIdx <= 0 ? '' : layout.tabs[currTabIdx].name);
      }
      // tab, field 這類物件都有 name, title 屬性, 但若 title 為空, 則應使用 name 來顯示該物件.
      let getTitleOrName = function (n) {
         return (n.title ? n.title : n.name);
      }
      let getSeedName = function(cell) {
         return mergePathKeyTab(currPath, gview.getKeyText(cell), getCurrTabName());
      }
      // 配合 renderLayout(), 在 tab 區, 增加選擇 tab 的 UI元素.
      let addTabElements = function (tabIdx, tab) {
         let div = document.createElement('div');
         div.className = 'tab';
         let elm = document.createElement('input');
         elm.id = tab.name;
         elm.type = 'radio';
         elm.name = 'tabs';
         elm.index = tabIdx;
         elm.onchange = setCurrTabIdx;
         div.appendChild(elm);
         elm = document.createElement('label');
         elm.htmlFor = tab.name;
         elm.textContent = getTitleOrName(tab);
         div.appendChild(elm);
         tabsArea.appendChild(div);
      }
      // 切換到選定的 tab, 配合選定的 tab 調整畫面, 並觸發載入事件: emitLoadGridView().
      let setCurrTabIdx = function (idx) {
         if (typeof idx !== 'number') // 如果不是 number, 則是 idx = tab UI元素的事件物件.
            idx = idx.target.index;    // idx.target = tab UI元素, index 在 addTabElements() 設定.
         if (currTabIdx == idx)
            return;
         currTabIdx = idx;
         let tab = layout.tabs[idx];
         let tabEle = document.getElementById(tab.name);
         if (tabEle)
            tabEle.checked = true;
         document.getElementById('btnReload').title = 'reload:\n'
             + mergePathKeyTab(currPath, undefined, idx == 0 ? '' : tab.name);
         emitLoadGridView(gview.getFirstCellText());
         gview.clearAll();
         let strHeader = '<th>' + getTitleOrName(layout.key) + '</th>';
         for (let fld of tab.fields)
           strHeader += '<th>' + getTitleOrName(fld) + '</th>';
         gview.addHeadRow(strHeader);
      }
      // 配合 renderLayout(), 在 seed 區(tab區的左邊), 增加路徑顯示及操作用的UI元件.
      let addPathSeedElements = function (path) {
         let nodes = parsePath(path);
         tabsArea.innerHTML = '';
         path = '/';
         for (let i = 0; ;) {
            let btn = document.createElement('button');
            btn.textContent = '/';
            btn.className = 'seed';
            btn.type = 'button';
            btn.value = path;
            prevPath = path;
            btn.onclick = ((ev) => emitPathChange(ev.target.value));
            tabsArea.appendChild(btn);
            if (i >= nodes.length)
               break;
            let n = nodes[i++];
            let isLast = (i >= nodes.length);
            btn = document.createElement('button');
            btn.className = 'seed';
            btn.disabled = true;
            let str = n.seed;
            if (n.tab != '')
               str += '^' + n.tab;
            path += str + '/';
            btn.textContent = str;
            tabsArea.appendChild(btn);
            if (isLast)
               break;
         }
      }
      // 當收到 updateRow() 時, 解析 args, 找出要更新的是哪個 tab.
      let parseTabIdx = function (args) {
         // args: '[[rowCount],[[key][^tab]]]
         if (args && args.length > 0) {
            let pTab = args.indexOf("^");
            if (pTab >= 0) {
               if (args.substring(pTab + 1) == layout.tabs[currTabIdx].name)
                  return currTabIdx;
               return -1;
            }
         }
         return 0;
      }
      // flags = undefined or "xHH"
      let parseHexFlags = function (flags) {
         return flags ? parseInt(flags.substring(1), 16) : 0;
      }
      // 判斷 accessRight 是否有寫入權限.
      let hasWriteAccess = function () {
         return (accessRights & 0x02); // AccessRight::Write;
      }

      // 若 path 為 currPath, 則解析 path 最後的 key^tab;
      // 且 tab 為 currTabIdx, 則傳回: { seed:key, tab:tabName }; 否則傳回 undefined;
      let parseLastKeyTab = function (path) {
         if (path.substring(0, currPath.length) != currPath)
            return undefined;
         let keytab = parsePath(path.substring(currPath.length));
         if (keytab.length <= 0)
            return undefined;
         keytab = keytab[0];
         if (keytab.tab == '') {
            if (currTabIdx != 0)
               return undefined;
         }
         else if (keytab.tab != layout.tabs[currTabIdx].name)
            return undefined;
         return keytab;
      }
      // 使用 parseLastKeyTab() 取得最後的 key, tab 後, 透過 gview.searchRow(key) 取得 row;
      let searchRowByFullPathName = function(path) {
         let keytab = parseLastKeyTab(path);
         if (keytab)
            return gview.searchRow(keytab.seed);
         return undefined;
      }

      // 當 edPath 輸入 [Esc]=取消輸入, [Enter]=確認移動到指定路徑.
      let edPathKeyDown = function (ev) {
         if (window.event)
            ev = window.event;
         if (ev.keyCode == 27)
            ev.target.blur();
         else if (ev.keyCode == 13) {
            ev.target.blur();
            emitPathChange(ev.target.value);
         }
         return true;
      }
      // 處理 btnReload 按下.
      let reload = function () {
         emitLoadGridView(undefined);
         return false;
      }

      // 增加一筆 row.
      let addNewRow = function (fieldValues) {
         if (document.getElementById('btnAddNewRow').disabled)
            return;
         // if (!fieldValues) 需要顯示加入的欄位嗎?
         fieldValues = '';
         let currKey = gview.getKeyText(gview.selectedCell);
         let key = prompt("在 " + getTitleOrName(layout.tabs[currTabIdx])
                          + " 新增一筆資料\n" + fieldValues + "\n請輸入要新增的「"
                          + getTitleOrName(layout.key) + "」"
                         , currKey);
         if (!key || key == currKey)
            return;
         let row = gview.searchRow(key);
         if (!row) {
            row = gview.addBodyRow(key);
            row.cells[0].classList.add('gvUpdatingCell');
            if (onFieldChanged)
               onFieldChanged(currPath, key, getCurrTabName(), fieldValues);
         }
         gview.setCellFocus(row.rowIndex, 0);
      }
      // 移除 row, 若 !cell (btnDeleteRow.onclick 事件) 則使用 gview.selectedCell
      let deleteRow = function (cell) {
         if (onDeleteRow && !document.getElementById('btnDeleteRow').disabled)
            onDeleteRow(currPath, gview.getKeyText(cell ? cell : gview.selectedCell));
      }

      // 將 row 的內容複製到 clipboard, lines[0]=curPath, lines[1]="fld=`value`,...";
      let rowToClipboard = function (cell) {
         let info = getSeedName(cell) + '\n';
         let cells = cell.parentNode.cells;
         let fields = layout.tabs[currTabIdx].fields;
         for (let i = 1; i < cells.length; ++i) {
            if (i != 1)
               info += ',';
            info += fields[i - 1].name + '=`' + cells[i].textContent + '`';
         }
         clipboard.textContent = info;
      }
      // 從 clipboard 取出先前儲存的欄位列表字串: "fld=`value`,...", 不包含 key.
      let clipboardToFieldValues = function () {
         let lines = clipboard.textContent.split('\n');
         let keytab = parseLastKeyTab(lines[0]);
         if (keytab)
            return lines[1];
         return undefined;
      }
   </script>
   <!-- create GridView UI element --> <script type="module">
      import {GridView} from "./gvTable.js"
      gview = new GridView(document.body);

      // 在 key cell click 時, 切換到 sapling.
      gview.onKeyCellClick = function(cell) {
         if (layout.tabs[currTabIdx].flags & 0x04) // TabFlag::NoSapling;
            return;
         if (onLoadLayout)
            onLoadLayout(currPath, cell.textContent, getCurrTabName());
      }

      // 在 selected cell 變動時, 變更相關 UI 元素的 title(hint) 訊息.
      gview.onSelectedCellChanged = function(cell) {
         document.getElementById('btnDeleteRow').title = 'delete: \"' + gview.getKeyText(cell) + '"';
      }

      // 在 gview.onEditConfirm() 觸發 onFieldChanged() 異動訊息,
      // 等 updateRow() 收到結果後再更新 cell.textContent.
      gview.onEditConfirm = function(cell, beforeText) {
         cell.classList.add('gvUpdatingCell');
         if (onFieldChanged) {
            let fieldValues = layout.tabs[currTabIdx].fields[cell.cellIndex - 1].name
                            + '=`' + cell.textContent.replace(/(?:\r\n|\r|\n)/g, ' ') + '`';
            onFieldChanged(currPath, gview.getKeyText(cell), getCurrTabName(), fieldValues);
         }
         cell.textContent = beforeText;
      }

      // 根據 tab.flags, field.flags, accessRights... 決定某 cell 是否允許編輯.
      gview.isCellEditable = function(cell) {
         // 根據 fld.flags, tab.flags, accessRights 決定某個 cell 是否為 readonly.
         let fldIndex = cell.cellIndex;
         if (!fldIndex || --fldIndex < 0)
            return false;
         if (!hasWriteAccess())
            return false;
         let tab = layout.tabs[currTabIdx];
         if (!(tab.flags & 0x01)) // writable?
            return false;
         let fld = tab.fields[fldIndex];
         // bit flag: 0x01 = readonly, 0x02 = hide;
         if (fld.flags & 0x01) // readonly?
            return false;
         return true;
      }

      // 處理鍵盤事件: [Insert]=addNewRow(); [Delete]=deleteRot(); [Backspace]=上一層.
      gview.onkeydown = function(ev) {
         let cell = document.activeElement;
         if (cell.isContentEditable)
            return true;
         if (ev.keyCode == 45) { // Insert
            if (ev.shiftKey) {   // [Shift-Ins]: Paste a row
               let fieldValues = clipboardToFieldValues();
               if (fieldValues)
                  addNewRow(fieldValues);
            }
            else if (ev.ctrlKey) // [Ctrl-Ins]: Copy current row.
               rowToClipboard(cell);
            else
               addNewRow();
            return false;
         }
         if (ev.keyCode == 46) { // Delete
            if (ev.altKey)
               return true;
            if (ev.shiftKey) {   // [Shift-Del]: Cut a row
               rowToClipboard(cell);
               deleteRow(cell);
            }
            else if (ev.ctrlKey) // [Ctrl-Del]:  Delete a row
               deleteRow(cell);
            return false;
         }
         if (ev.keyCode == 8) {  // Backspace: 回到上一層.
            emitPathChange(prevPath);
            return false;
         }
         return true;
      }

      // 使用「oncontextmenu 事件」處理 SeedCommand.
      gview.gvTable.oncontextmenu = gvTable_oncontextmenu;
   </script>
   <!-- ContextMenu for SeedCommand -->
   <div id="formSeedMenu" class="fon9-fullWindowBack" oncontextmenu="return false;">
      <div id="divSeedMenu" class="fon9-contextMenu" tabindex="0" onblur="closeSeedContextMenu();">
         <div id="divSeedMenuTitle" class="fon9-contextMenuTitle"></div>
         <div id="divSeedMenuItems"></div>
      </div>
   </div>
   <script>
      let prevPathCommandsSet;
      function gvTable_oncontextmenu(ev) {
         let cell = ev.target;
         if (cell != gview.selectedCell)
            cell.focus();
         if (cell.parentNode.rowIndex >= gview.getFirstBodyRowIndex()
         && !cell.isContentEditable
         && !(layout.tabs[currTabIdx].flags & 0x20) // TabFlag::NoSeedCommand
         && (accessRights & 0x04) // AccessRight::Exec;
         && onSeedCommand) {
            let curSeedPath = mergePathKeyTab(currPath, '', getCurrTabName());
            if ((layout.tabs[currTabIdx].flags & 0x10) // TabFlag::HasSameCommandsSet = 0x10;
             && curSeedPath == prevPathCommandsSet
             && divSeedMenuItems.innerHTML) {
               // 只需查一次可用指令: 使用上次查到的 divSeedMenuItems;
            }
            else {
               prevPathCommandsSet = curSeedPath;
               divSeedMenuItems.innerHTML = '';
               onSeedCommand(getSeedName(cell), "?");
            }
            displaySeedContextMenu(ev);
         }
         return false;
      }
      function displaySeedContextMenu(ev) {
         formSeedMenu.style.display = "block"; // 要先設定 display, 底下的 offsetWidth, offsetHeight 才會正確.
         divSeedMenuTitle.textContent = gview.getKeyText(ev.target);
         divSeedMenu.focus();
         let varea = document.documentElement;
         let left = ev.clientX, right = varea.clientWidth - divSeedMenu.offsetWidth;
         divSeedMenu.style.left = (left > right ? right : left) + "px";
         let top = ev.clientY, bottom = varea.clientHeight - divSeedMenu.offsetHeight;
         divSeedMenu.style.top = (top > bottom ? bottom : top) + "px";
      }
      function adjustSeedContextMenu() {
         let varea = document.documentElement;
         let right = varea.clientWidth - divSeedMenu.offsetWidth;
         if (divSeedMenu.offsetLeft > right)
            divSeedMenu.style.left = right + "px";
         let bottom = varea.clientHeight - divSeedMenu.offsetHeight;
         if (divSeedMenu.offsetTop > bottom)
            divSeedMenu.style.top = bottom + "px";
      }
      function closeSeedContextMenu() {
         if (formSeedMenu.style.display != 'none') {
            gview.gvArea.disabled = false;
            formSeedMenu.style.display = 'none';
            if (gview.selectedCell)
               gview.selectedCell.focus();
         }
      }
      window.onclick = function (event) {
         if (event.target == formSeedMenu)
            closeSeedContextMenu();
      }
      window.onkeyup = function(event) {
         if (event.keyCode == 27)//escape
            closeSeedContextMenu();
      }
      function buildSeedMenuItems(res, errmsg) {
         if (formSeedMenu.style.display == 'none')
            return;
         let cmds = res.split('\n');
         let seedName = cmds[0].substring(2); // remove "?\x01" = seedName;
         if (seedName != getSeedName(gview.selectedCell))
            return;
         let mitem;
         if (errmsg) {
            mitem = document.createElement('div');
            mitem.textContent = errmsg;
            mitem.className = 'fon9-contextMenuItem';
            mitem.onclick = closeSeedContextMenu;
            divSeedMenuItems.appendChild(mitem);
            adjustSeedContextMenu();
            return;
         }
         for (let i = 1; i < cmds.length; ++i) {
            let cmd = cmds[i].split('\x01');
            if (cmd.length >= 3) // cmd + DisplayText + Prompt(for input text)
               cmd[1] += '\u2026'; // "..."
            mitem = document.createElement('div');
            mitem.seedcmd = cmd;
            mitem.textContent = (cmd.length > 1 ? cmd[1] : cmd[0]);
            mitem.className = 'fon9-contextMenuItem';
            divSeedMenuItems.appendChild(mitem);
            mitem.onclick = function (ev) {
               closeSeedContextMenu();
               let seedcmd = ev.target.seedcmd;
               let cmd = seedcmd[0];
               if (seedcmd.length >= 3) {
                  let args = prompt(seedcmd[2]);
                  if (args == null)
                     return;
                  cmd += ' ' + args;
               }
               onSeedCommand(seedName, cmd);
            }
         }
         adjustSeedContextMenu();
      }
   </script>
</body>
</html>
